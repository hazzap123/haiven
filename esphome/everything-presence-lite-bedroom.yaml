substitutions:
  name: everything-presence-lite-bedroom
  friendly_name: Everything Presence Lite Bedroom
  illuminance_update_interval: "2s"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  project:
    name: "EverythingSmartTechnology.Everything Presence Lite"
    version: "1.3.1"
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    priority: -100
    then:
      - button.press: get_mmwave_firmware
      - binary_sensor.template.publish:
          id: zone1_occupancy
          state: false
      - binary_sensor.template.publish:
          id: zone2_occupancy
          state: false
      - binary_sensor.template.publish:
          id: zone3_occupancy
          state: false
      - binary_sensor.template.publish:
          id: zone4_occupancy
          state: false

esp32:
  board: esp32dev
  framework:
    type: esp-idf

api:
  encryption:
    key: !secret api_encryption_key

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "EPL-Bedroom Fallback"

captive_portal:

ota:
  platform: esphome

logger:
  level: ERROR

# Bluetooth proxy for Shelly BLU and other BLE devices
esp32_ble_tracker:
  scan_parameters:
    active: true

bluetooth_proxy:
  active: true

i2c:
  - id: bus_a
    sda: 21
    scl: 22
    scan: true

globals:
  - id: mmwave_update_time
    type: unsigned long
    restore_value: False
    initial_value: '0'
  - id: mmwave_update_interval
    type: unsigned long
    restore_value: False
    initial_value: '250'
  - id: target1_last_update
    type: unsigned long
    initial_value: '0'
    restore_value: False
  - id: target1_reset
    type: int
    initial_value: "1"
    restore_value: False
  - id: entities_update_count
    type: unsigned int
    restore_value: False
    initial_value: '0'
  - id: entities_update_max_count
    type: unsigned int
    restore_value: False
    initial_value: '0'
  - id: extra_entities
    type: unsigned int
    restore_value: False
    initial_value: '0'
  - id: assumed_present_until_ms
    type: unsigned long
    restore_value: False
    initial_value: '0'
  - id: assumed_present_active
    type: bool
    restore_value: False
    initial_value: 'false'
  - id: last_zone_hold
    type: int
    restore_value: False
    initial_value: '0'
  - id: last_target_x_mm
    type: float
    restore_value: False
    initial_value: '0'
  - id: last_target_y_mm
    type: float
    restore_value: False
    initial_value: '0'

interval:
  - interval: 1s
    then:
      - lambda: |-
          unsigned long now = millis();
          unsigned long timeout_ms = (unsigned long)(id(aggressive_timeout).state * 1000);
          if (id(aggressive_target_clearing).state) {
            if ((now - id(target1_last_update)) > timeout_ms) {
              if (id(target1_reset) == 0) {
                if (id(target1_active).state == true) {
                  ESP_LOGD("custom", "No update in 3s, clearing");
                  id(reboot_mmwave_sensor).press();
                  id(target1_reset) = 1;
                }
              }
            }
          }

light:
  - platform: status_led
    name: ESP32 LED
    id: esp32_led
    pin: GPIO14
    internal: False
    restore_mode: ALWAYS_OFF
    entity_category: config

text_sensor:
  - platform: template
    disabled_by_default: True
    name: "mmWave Firmware"
    id: "firmware_version"
    entity_category: diagnostic

button:
  - platform: restart
    icon: mdi:power-cycle
    name: "ESP Reboot"
    entity_category: config
  - platform: template
    id: get_mmwave_firmware
    internal: True
    entity_category: config
    disabled_by_default: True
    on_press:
      then:
      - switch.turn_on: mmwave_configuration
      - delay: 1s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xA0, 0x00, 0x04, 0x03, 0x02, 0x01]
      - lambda: |-
          uint8_t response[20];
          if (id(uart_bus).read_array(response, 20)) {
            int firmware_major = response[13];
            int firmware_minor = response[12];
            char firmware_version_str[32];
            sprintf(firmware_version_str, "V%d.%02d", firmware_major, firmware_minor);
            id(firmware_version).publish_state(std::string(firmware_version_str));
          } else {
            id(firmware_version).publish_state("Unknown");
          }
      - switch.turn_off: mmwave_configuration
      - delay: 1s
  - platform: template
    name: "Reboot mmWave Sensor"
    id: reboot_mmwave_sensor
    disabled_by_default: True
    entity_category: config
    on_press:
      then:
      - switch.turn_on: mmwave_configuration
      - delay: 1s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xA3, 0x00, 0x04, 0x03, 0x02, 0x01]
  - platform: template
    name: "Factory Reset mmWave Sensor"
    id: factory_reset_mmwave_sensor
    disabled_by_default: True
    entity_category: config
    on_press:
      then:
      - logger.log: "Performing Factory Reset"
      - switch.turn_on: mmwave_configuration
      - delay: 2s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xA2, 0x00, 0x04, 0x03, 0x02, 0x01]
      - delay: 2s
      - switch.turn_off: mmwave_configuration
      - delay: 2s
      - button.press: reboot_mmwave_sensor

switch:
  - platform: template
    name: "mmWave Configuration Mode"
    id: mmwave_configuration
    disabled_by_default: True
    internal: True
    entity_category: config
    optimistic: true
    restore_mode: DISABLED
    turn_on_action:
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x04, 0x00, 0xFF, 0x00, 0x01, 0x00, 0x04, 0x03, 0x02, 0x01]
    turn_off_action:
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xFE, 0x00, 0x04, 0x03, 0x02, 0x01]
  - platform: template
    name: "mmWave Bluetooth"
    id: bluetooth_switch
    optimistic: true
    disabled_by_default: True
    entity_category: config
    turn_on_action:
      - switch.turn_on: mmwave_configuration
      - delay: 2s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x04, 0x00, 0xA4, 0x00, 0x01, 0x00, 0x04, 0x03, 0x02, 0x01]
      - delay: 2s
      - button.press: reboot_mmwave_sensor
      - delay: 2s
      - switch.turn_off: mmwave_configuration
    turn_off_action:
      - switch.turn_on: mmwave_configuration
      - delay: 2s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x04, 0x00, 0xA4, 0x00, 0x00, 0x00, 0x04, 0x03, 0x02, 0x01]
      - delay: 2s
      - button.press: reboot_mmwave_sensor
      - delay: 2s
      - switch.turn_off: mmwave_configuration
  - platform: template
    name: "Stale Target Reset"
    id: aggressive_target_clearing
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: True
    entity_category: config
  - platform: template
    name: "Upside Down Mounting"
    id: inverse_mounting
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: True
    entity_category: config
    icon: "mdi:rotate-180"
  - platform: template
    name: "Entry Exit Enabled"
    id: entry_exit_enabled
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    entity_category: config
  - platform: template
    name: "Polygon Zones"
    id: polygon_zones_enabled
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    entity_category: config
    icon: "mdi:vector-polygon"
    disabled_by_default: false

binary_sensor:
  - platform: template
    name: "Occupancy"
    device_class: occupancy
    id: occupancy
    filters:
      - delayed_off: !lambda return (id(off_delay).state * 1000);
  - platform: template
    name: "Zone 1 Occupancy"
    device_class: occupancy
    id: zone1_occupancy
    filters:
      - delayed_off: !lambda return (id(zone_1_off_delay).state * 1000);
  - platform: template
    name: "Zone 2 Occupancy"
    device_class: occupancy
    id: zone2_occupancy
    filters:
      - delayed_off: !lambda return (id(zone_2_off_delay).state * 1000);
    disabled_by_default: true
  - platform: template
    name: "Zone 3 Occupancy"
    device_class: occupancy
    id: zone3_occupancy
    filters:
      - delayed_off: !lambda return (id(zone_3_off_delay).state * 1000);
    disabled_by_default: true
  - platform: template
    name: "Zone 4 Occupancy"
    device_class: occupancy
    id: zone4_occupancy
    filters:
      - delayed_off: !lambda return (id(zone_4_off_delay).state * 1000);
    disabled_by_default: true
  - platform: template
    name: "Target 1 Active"
    id: target1_active
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Active"
    id: target2_active
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Active"
    id: target3_active
    entity_category: diagnostic
  - platform: template
    name: "Assumed Present"
    id: assumed_present
    entity_category: diagnostic

number:
  - platform: template
    name: "Illuminance Offset"
    id: illuminance_offset_ui
    unit_of_measurement: "lx"
    min_value: -100
    max_value: 100
    step: 5
    mode: slider
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:brightness-5"
    entity_category: config
    on_value:
      - lambda: 'id(illuminance_sensor).update();'
  - platform: template
    name: "Occupancy Off Delay"
    id: off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    entity_category: config
  - platform: template
    name: "Max Distance"
    id: distance
    max_value: 600
    min_value: 0
    unit_of_measurement: "cm"
    step: 1
    optimistic: True
    restore_value: True
    initial_value: 600
    entity_category: config
  - platform: template
    name: "Installation Angle"
    id: installation_angle_ui
    unit_of_measurement: "º"
    min_value: -45
    max_value: 45
    step: 1
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:angle-acute"
    entity_category: config
  - platform: template
    name: "Exit Threshold Pct"
    id: exit_threshold_pct
    min_value: 0
    max_value: 100
    step: 1
    optimistic: true
    restore_value: true
    initial_value: 10
    unit_of_measurement: "%"
    entity_category: config
  - platform: template
    name: "Assume Present Timeout"
    id: assume_present_timeout_s
    min_value: 0
    max_value: 600
    step: 1
    optimistic: true
    restore_value: true
    initial_value: 15
    unit_of_measurement: "s"
    entity_category: config
  - platform: template
    name: "Zone 1 Begin X"
    id: zone1_begin_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    initial_value: -4000
    entity_category: config
  - platform: template
    name: "Zone 1 End X"
    id: zone1_end_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    initial_value: 4000
    entity_category: config
  - platform: template
    name: "Zone 1 Begin Y"
    id: zone1_begin_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    initial_value: 0
    entity_category: config
  - platform: template
    name: "Zone 1 End Y"
    id: zone1_end_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    initial_value: 6000
    entity_category: config
  - platform: template
    name: "Zone 1 Occupancy Off Delay"
    id: zone_1_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    entity_category: config
  - platform: template
    name: "Zone 2 Begin X"
    id: zone2_begin_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    disabled_by_default: true
    entity_category: config
  - platform: template
    name: "Zone 2 End X"
    id: zone2_end_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    disabled_by_default: true
    entity_category: config
  - platform: template
    name: "Zone 2 Begin Y"
    id: zone2_begin_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    disabled_by_default: true
    entity_category: config
  - platform: template
    name: "Zone 2 End Y"
    id: zone2_end_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    disabled_by_default: true
    entity_category: config
  - platform: template
    name: "Zone 2 Occupancy Off Delay"
    id: zone_2_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    disabled_by_default: true
    entity_category: config
  - platform: template
    name: "Zone 3 Occupancy Off Delay"
    id: zone_3_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    disabled_by_default: true
    entity_category: config
  - platform: template
    name: "Zone 4 Occupancy Off Delay"
    id: zone_4_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    disabled_by_default: true
    entity_category: config
  - platform: template
    name: "Stale Target Reset Timeout"
    id: aggressive_timeout
    min_value: 1
    max_value: 60
    step: 1
    unit_of_measurement: "s"
    optimistic: true
    restore_value: true
    initial_value: 3
    entity_category: config
  - platform: template
    name: "Occupancy Mask 1 Begin X"
    id: occupancy_mask_1_begin_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    entity_category: config
  - platform: template
    name: "Occupancy Mask 1 End X"
    id: occupancy_mask_1_end_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    entity_category: config
  - platform: template
    name: "Occupancy Mask 1 Begin Y"
    id: occupancy_mask_1_begin_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    entity_category: config
  - platform: template
    name: "Occupancy Mask 1 End Y"
    id: occupancy_mask_1_end_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: True
    restore_value: True
    entity_category: config
  - platform: template
    name: "Entry Zone 1 Begin X"
    id: entry_zone_1_begin_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: true
    restore_value: true
    initial_value: 0
    entity_category: config
  - platform: template
    name: "Entry Zone 1 End X"
    id: entry_zone_1_end_x
    max_value: 6000
    min_value: -6000
    unit_of_measurement: "mm"
    step: 10
    optimistic: true
    restore_value: true
    initial_value: 0
    entity_category: config
  - platform: template
    name: "Entry Zone 1 Begin Y"
    id: entry_zone_1_begin_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: true
    restore_value: true
    initial_value: 0
    entity_category: config
  - platform: template
    name: "Entry Zone 1 End Y"
    id: entry_zone_1_end_y
    max_value: 6000
    min_value: -1560
    unit_of_measurement: "mm"
    step: 10
    optimistic: true
    restore_value: true
    initial_value: 0
    entity_category: config

sensor:
  - platform: bh1750
    name: Illuminance
    id: illuminance_sensor
    i2c_id: bus_a
    address: 0x23
    update_interval: ${illuminance_update_interval}
    accuracy_decimals: 0
    filters:
      - lambda: "return x + id(illuminance_offset_ui).state;"
      - or:
        - delta: 5%
        - delta: 5
      - clamp:
          min_value: 0
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
  - platform: template
    name: "Assumed Present Remaining"
    id: assumed_present_remaining_s
    unit_of_measurement: "s"
    accuracy_decimals: 0
    update_interval: never
    entity_category: diagnostic
  - platform: template
    name: "Target 1 X"
    id: target1_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Y"
    id: target1_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Speed"
    id: target1_speed
    accuracy_decimals: 2
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Resolution"
    id: target1_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Angle"
    id: target1_angle
    accuracy_decimals: 0
    unit_of_measurement: '°'
    state_class: measurement
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Distance"
    id: target1_distance
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 X"
    id: target2_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Y"
    id: target2_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Speed"
    id: target2_speed
    accuracy_decimals: 2
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Resolution"
    id: target2_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Angle"
    id: target2_angle
    accuracy_decimals: 0
    unit_of_measurement: '°'
    state_class: measurement
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Distance"
    id: target2_distance
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 X"
    id: target3_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Y"
    id: target3_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Speed"
    id: target3_speed
    accuracy_decimals: 2
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Resolution"
    id: target3_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Angle"
    id: target3_angle
    accuracy_decimals: 0
    unit_of_measurement: '°'
    state_class: measurement
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Distance"
    id: target3_distance
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Zone 1 Target Count"
    id: zone1_target_count
    accuracy_decimals: 0
    unit_of_measurement: " "
    entity_category: diagnostic
  - platform: template
    name: "Zone 2 Target Count"
    id: zone2_target_count
    accuracy_decimals: 0
    disabled_by_default: true
    unit_of_measurement: " "
    entity_category: diagnostic

select:
  - platform: template
    name: 'Update speed'
    id: "update_speed_select"
    icon: 'mdi:speedometer'
    optimistic: true
    restore_value: true
    entity_category: config
    options:
      - Faster (0.1s)
      - Fast (0.2s)
      - Normal (0.3s)
      - Slow (0.4s)
      - Slower (0.5s)
    initial_option: Normal (0.3s)
    on_value:
      then:
        - lambda: id(mmwave_update_interval) = (i + 1) * 100;
  - platform: template
    name: "Tracking Behaviour"
    id: tracking_behaviour
    icon: 'mdi:dots-vertical'
    optimistic: true
    restore_value: true
    entity_category: config
    options:
      - None
      - Targets Position
      - Above + Zone count
      - Above + Targets active
      - Above + Distance and Angle
      - Above + Speed and Resolution
    initial_option: Above + Speed and Resolution
    on_value:
      then:
        - lambda: |-
            id(extra_entities) = i;

uart:
  id: uart_bus
  tx_pin:
    number: GPIO17
    mode:
      input: true
      pullup: true
  rx_pin:
    number: GPIO16
    mode:
      input: true
      pullup: true
  baud_rate: 256000
  parity: NONE
  stop_bits: 1
  data_bits: 8
  debug:
    direction: BOTH
    dummy_receiver: True
    after:
      delimiter: [0X55, 0XCC]
    sequence:
      - lambda: |-
          if ((millis() - id(mmwave_update_time)) <= id(mmwave_update_interval)) {
            return;
          };
          id(mmwave_update_time) = millis();

          if (bytes.size() != 30) {
            return;
          }

          id(target1_last_update) = millis();
          id(target1_reset) = 0;

          bool update_entities = false;
          if(id(extra_entities) != 0) {
            id(entities_update_count) += 1;
            update_entities = id(entities_update_count) >= id(entities_update_max_count);
            if (update_entities) {
              id(entities_update_count) = 0;
            }
          }

          const static float RADIANS_TO_DEGREES = 180.0 / 3.14159265358979323846;
          const static int16_t MIN_INT16_VAL = -32768;

          float max_distance = float(id(distance).state) * 10;
          float installation_angle = id(installation_angle_ui).state * 3.14159265358979323846 / 180.0;

          int zone1_count = 0;
          int zone1_begin_x_value = min((int)id(zone1_begin_x).state, (int)id(zone1_end_x).state);
          int zone1_end_x_value = max((int)id(zone1_begin_x).state, (int)id(zone1_end_x).state);
          int zone1_begin_y_value = min((int)id(zone1_begin_y).state, (int)id(zone1_end_y).state);
          int zone1_end_y_value = max((int)id(zone1_begin_y).state, (int)id(zone1_end_y).state);

          int occupancy_mask_1_begin_x_value = min((int)id(occupancy_mask_1_begin_x).state, (int)id(occupancy_mask_1_end_x).state);
          int occupancy_mask_1_end_x_value = max((int)id(occupancy_mask_1_begin_x).state, (int)id(occupancy_mask_1_end_x).state);
          int occupancy_mask_1_begin_y_value = min((int)id(occupancy_mask_1_begin_y).state, (int)id(occupancy_mask_1_end_y).state);
          int occupancy_mask_1_end_y_value = max((int)id(occupancy_mask_1_begin_y).state, (int)id(occupancy_mask_1_end_y).state);

          bool p1_detected = *((uint16_t *)(&bytes[10])) != 0;
          bool p2_detected = *((uint16_t *)(&bytes[18])) != 0;
          bool p3_detected = *((uint16_t *)(&bytes[26])) != 0;

          if (p1_detected) {
            int16_t p1_x = *((int16_t *)(&bytes[4]));
            if (p1_x < 0) p1_x += MIN_INT16_VAL;
            else p1_x = -p1_x;

            int16_t p1_y = *((int16_t *)(&bytes[6]));
            if (p1_y < 0) p1_y += MIN_INT16_VAL;
            else p1_y = -p1_y;

            float p1_distance = sqrt(p1_x * p1_x + p1_y * p1_y);

            if (id(inverse_mounting).state) {
              p1_x = -p1_x;
            }

            if (p1_distance > max_distance) {
              p1_detected = false;
            } else {
              if ((occupancy_mask_1_begin_x_value <= p1_x && p1_x <= occupancy_mask_1_end_x_value) &&
                  (occupancy_mask_1_begin_y_value <= p1_y && p1_y <= occupancy_mask_1_end_y_value)) {
                p1_detected = false;
              } else {
                if ((zone1_begin_x_value <= p1_x && p1_x <= zone1_end_x_value) &&
                    (zone1_begin_y_value <= p1_y && p1_y <= zone1_end_y_value)) {
                  zone1_count++;
                }
              }
              if (update_entities && id(extra_entities) >= 1) {
                id(target1_x).publish_state(p1_x);
                id(target1_y).publish_state(p1_y);
                if (id(extra_entities) >= 3) {
                  id(target1_active).publish_state(true);
                }
                if (id(extra_entities) >= 4) {
                  float p1_angle = atan2(p1_y, p1_x) * RADIANS_TO_DEGREES - 90;
                  id(target1_angle).publish_state(p1_angle);
                  id(target1_distance).publish_state(p1_distance);
                }
                if (id(extra_entities) >= 5) {
                  uint16_t p1_resolution = *((uint16_t *)(&bytes[10]));
                  int16_t p1_speed = *((int16_t *)(&bytes[8]));
                  if (p1_speed < 0) p1_speed += MIN_INT16_VAL;
                  else p1_speed = -p1_speed;
                  id(target1_speed).publish_state(p1_speed / 100.0);
                  id(target1_resolution).publish_state(p1_resolution);
                }
              }
            }
          }

          if (p2_detected) {
            int16_t p2_x = *((int16_t *)(&bytes[12]));
            if (p2_x < 0) p2_x += MIN_INT16_VAL;
            else p2_x = -p2_x;

            int16_t p2_y = *((int16_t *)(&bytes[14]));
            if (p2_y < 0) p2_y += MIN_INT16_VAL;
            else p2_y = -p2_y;

            float p2_distance = sqrt(p2_x * p2_x + p2_y * p2_y);

            if (id(inverse_mounting).state) {
              p2_x = -p2_x;
            }

            if (p2_distance > max_distance) {
              p2_detected = false;
            } else {
              if (update_entities && id(extra_entities) >= 1) {
                id(target2_x).publish_state(p2_x);
                id(target2_y).publish_state(p2_y);
                if (id(extra_entities) >= 3) {
                  id(target2_active).publish_state(true);
                }
              }
            }
          }

          if (p3_detected) {
            int16_t p3_x = *((int16_t *)(&bytes[20]));
            if (p3_x < 0) p3_x += MIN_INT16_VAL;
            else p3_x = -p3_x;

            int16_t p3_y = *((int16_t *)(&bytes[22]));
            if (p3_y < 0) p3_y += MIN_INT16_VAL;
            else p3_y = -p3_y;

            float p3_distance = sqrt(p3_x * p3_x + p3_y * p3_y);

            if (id(inverse_mounting).state) {
              p3_x = -p3_x;
            }

            if (p3_distance > max_distance) {
              p3_detected = false;
            } else {
              if (update_entities && id(extra_entities) >= 1) {
                id(target3_x).publish_state(p3_x);
                id(target3_y).publish_state(p3_y);
                if (id(extra_entities) >= 3) {
                  id(target3_active).publish_state(true);
                }
              }
            }
          }

          bool occ_now = p1_detected || p2_detected || p3_detected;
          id(occupancy).publish_state(occ_now);

          bool z1 = zone1_count > 0;
          id(zone1_occupancy).publish_state(z1);

          if (update_entities && id(extra_entities) >= 2) {
            id(zone1_target_count).publish_state(zone1_count);
          }

          if (!p1_detected && update_entities && id(extra_entities) >= 3) {
            id(target1_active).publish_state(false);
          }
          if (!p2_detected && update_entities && id(extra_entities) >= 3) {
            id(target2_active).publish_state(false);
          }
          if (!p3_detected && update_entities && id(extra_entities) >= 3) {
            id(target3_active).publish_state(false);
          }
